{
  "$schema": "./cdk.schema.json",
  "Resources": {
    "HelloWorldFunction": {
      "Type": "@aws-cdk/aws-lambda.Function",
      "Properties": {
        "handler": "index.handler",
        "runtime": "NodeJS810",
        "code": {
          "asset": { "path": "./src" }
        },
        "events": [
          { "ApiEventSource": { "path": "/hello", "method": "GET" } },
          { "ApiEventSource": { "path": "/hi/there", "method": "POST" } }
        ]
      }
    },
    "Table": {
      "Type": "@aws-cdk/aws-dynamodb.Table",
      "Properties": {
        "partitionKey": {
          "name": "ID",
          "type": "String"
        }
      }
    },

    "VPC": {
      "Type": "@aws-cdk/aws-ec2.VpcNetwork",
      "Properties": {
        "maxAZs": 1
      }
    },
    "Cluster": {
      "Type": "@aws-cdk/aws-ecs.Cluster",
      "Properties": {
        "vpc": { "Ref": "VPC" }
      }
    },
    "MyTaskDef": {
      "Type": "@aws-cdk/aws-ecs.TaskDefinition",
      "Properties": {
        "compatibility": "Fargate",
        "family": "redis",
        "cpu": "1024",
        "memoryMiB": "1GB",
        "networkMode": "AwsVpc"
      }
    },
    "ContainerDef": {
      "Type": "@aws-cdk/aws-ecs.ContainerDefinition",
      "Properties": {
        "task": { "Ref": "MyTaskDef" },
        "essential": true,
        "memoryLimitMiB": 1024,
        "image": {
          "fromDockerHub": {
            "name": "redis"
          }
        }
      }
    },
    "Service": {
      "Type": "@aws-cdk/aws-ecs.FargateService",
      "Properties": {
        "cluster": { "Ref": "Cluster" },
        "taskDefinition": { "Ref": "MyTaskDef" }
      }
    }
  },
  "Outputs": {
    "HelloWorldApi": {
      "Description": "API Gateway endpoint URL for Prod stage for Hello World function",
      "Value": { "Fn::GetAtt": [ "HelloWorldFunction", "url" ] }
    }
  }
}
